# 违规状态管理功能

## 功能概述

违规状态管理功能实现了基于黄牌和红牌的管理规则，帮助跟踪和管理员工的违规行为。

## 管理规则

1. **黄牌累积规则**：每周收到黄牌，2张黄牌会变成红牌
2. **黄牌恢复规则**：次周如果不违规，恢复一张黄牌（仅恢复黄牌，最多恢复到0张）
3. **红牌规则**：红牌不会自动恢复，需要等待黄牌恢复后重新累积
4. **状态分类**：
   - 正常：无黄牌和红牌
   - 黄牌：有1张黄牌
   - 红牌：有红牌（无论黄牌数量）

## 数据结构

### 违规记录表 (disciplinary_record)
- `employee_name`: 员工姓名
- `reason`: 违规原因
- `type`: 违规类型
- `employee_id`: 员工ID
- `created_at`: 创建时间
- **注意**：违规记录表只存储黄牌记录，红牌通过计算得出

### 违规状态计算
- `currentYellowCards`: 当前黄牌数量
- `currentRedCards`: 当前红牌数量（通过计算得出）
- `status`: 当前状态 ('normal', 'yellow', 'red')
- `statusHistory`: 状态变化历史

## 计算逻辑

### 黄牌升级为红牌
- 每2张黄牌自动升级为1张红牌
- 升级后剩余黄牌数量 = 总黄牌数量 % 2

### 黄牌恢复机制
- 只有在没有红牌的情况下才能恢复黄牌
- 每周无违规时，恢复1张黄牌
- 最多恢复到0张黄牌
- 有红牌时不能恢复黄牌

### 红牌机制
- 红牌不会自动恢复
- 需要等待黄牌恢复后重新累积
- 红牌会一直保持，直到黄牌恢复完毕

## 功能特性

### 1. 自动状态计算
- 根据历史违规记录自动计算当前状态
- 按周统计违规次数
- 自动处理黄牌升级为红牌的逻辑

### 2. 状态显示
- 在员工管理列表中显示违规状态
- 使用颜色区分不同状态：
  - 绿色：正常
  - 橙色：黄牌
  - 红色：红牌

### 3. 详细信息查看
- 点击违规状态可查看详细信息
- 显示黄牌和红牌数量
- 显示距离红牌的剩余黄牌数量
- 显示状态变化历史

### 4. 状态预测
- 预测下周状态变化
- 显示可能的恢复或升级情况

## 使用方法

### 查看违规状态
1. 在员工管理页面，查看"违规状态"列
2. 点击状态标签查看详细信息
3. 在详情弹窗中查看状态历史和预测

### 添加违规记录
1. 在违规记录页面添加新的违规记录
2. 系统会自动计算并更新员工状态
3. 状态变化会记录在历史中

## 技术实现

### 核心工具函数
- `calculateViolationStatus()`: 计算违规状态
- `getStatusDisplayText()`: 获取状态显示文本
- `getStatusColor()`: 获取状态颜色
- `getStatusDescription()`: 获取状态详细说明
- `getYellowCardsToRedCard()`: 计算距离红牌的黄牌数量
- `predictNextWeekStatus()`: 预测下周状态

### API接口
- `getEmployeeViolationStatus()`: 获取单个员工违规状态
- `getEmployeeViolationStatuses()`: 批量获取员工违规状态
- `getEmployeeViolationHistory()`: 获取违规历史

### 数据库结构
- 使用现有的 `disciplinary_record` 表
- 违规记录只存储黄牌信息
- 红牌通过计算得出，不直接存储

## 注意事项

1. **周计算规则**：使用ISO周格式 (YYYY-WW)
2. **状态更新**：每次添加违规记录后会自动重新计算状态
3. **历史记录**：所有状态变化都会记录在历史中
4. **性能考虑**：大量数据时建议使用批量查询
5. **数据一致性**：违规记录表只存储黄牌，红牌通过计算确保一致性

## 未来扩展

1. **自动提醒**：接近红牌时发送提醒
2. **统计报表**：违规状态统计和分析
3. **规则配置**：支持自定义黄牌和红牌规则
4. **批量操作**：支持批量更新违规状态
5. **状态快照**：定期保存状态快照用于历史分析 