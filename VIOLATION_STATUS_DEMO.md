# 违规状态管理功能演示

## 功能概述

违规状态管理功能已经成功实现，支持基于黄牌和红牌的管理规则。

## 实现的功能

### 1. 违规状态计算
- ✅ 自动计算员工的黄牌和红牌数量
- ✅ 按周统计违规记录
- ✅ 2张黄牌自动升级为1张红牌
- ✅ 无违规周自动恢复1张黄牌（仅恢复黄牌，最多恢复到0张）
- ✅ 红牌不会自动恢复，需要等待黄牌恢复后重新累积

### 2. 界面显示
- ✅ 在员工管理列表中显示"违规状态"列
- ✅ 使用颜色区分不同状态：
  - 🟢 绿色：正常状态
  - 🟡 橙色：黄牌状态
  - 🔴 红色：红牌状态
- ✅ 移除了"违规数量"列，简化界面

### 3. 详细信息查看
- ✅ 单击违规状态标签查看状态详情
- ✅ 双击违规状态标签查看违规记录
- ✅ 显示当前黄牌和红牌数量
- ✅ 显示距离红牌的剩余黄牌数量
- ✅ 显示状态变化历史

### 4. 数据操作同步
- ✅ Excel下载功能与主表格列结构完全一致
- ✅ Excel上传功能支持新的列名格式
- ✅ 批量上传预览表格与主表格保持一致
- ✅ 违规状态信息包含在Excel导出中

## 使用示例

### 场景1：员工无违规记录
```
员工：张三
违规状态：🟢 正常
黄牌：0张
红牌：0张
总违规：0次
```

### 场景2：员工有1张黄牌
```
员工：李四
违规状态：🟡 黄牌 1张
黄牌：1张
红牌：0张
总违规：1次
还需1张黄牌升级为红牌
```

### 场景3：员工有红牌
```
员工：王五
违规状态：🔴 红牌 1张
黄牌：0张
红牌：1张
总违规：2次
当前有1张红牌，红牌不会自动恢复，需要等待黄牌恢复后重新累积
```

## 界面交互

### 违规状态列操作
- **单击**：查看违规状态详情（黄牌/红牌数量、状态历史等）
- **双击**：查看违规记录列表
- **悬停**：显示提示信息（黄牌和红牌数量）

### 表格列结构
1. 员工姓名
2. 员工UID
3. 状态
4. 开通时间
5. 持有周期
6. **违规状态** ← 新增列
7. 创建时间
8. 操作

## 数据操作

### Excel下载
- 下载的Excel文件包含所有主表格列
- 违规状态信息自动计算并包含在导出中
- 列名与界面显示保持一致

### Excel上传
- 支持新的列名格式（"状态"而不是"员工状态"）
- 兼容旧格式，自动识别两种列名
- 批量上传预览表格与主表格结构一致

### 批量操作
- 批量上传预览显示与主表格相同的列结构
- 状态字段支持颜色标签显示
- 持有周期自动计算并显示

## 技术实现

### 核心文件
1. `src/utils/violationStatusUtils.ts` - 违规状态计算工具
2. `src/lib/disciplinaryRecordApi.ts` - 违规记录API扩展
3. `src/pages/EmployeeManage.tsx` - 员工管理页面更新
4. `src/types/employee.ts` - 类型定义更新
5. `src/utils/employeeExcelUtils.ts` - Excel数据操作工具

### 关键函数
- `calculateViolationStatus()` - 计算违规状态
- `getStatusDisplayText()` - 获取状态显示文本
- `getStatusColor()` - 获取状态颜色
- `getStatusDescription()` - 获取状态详细说明
- `downloadEmployeeData()` - 下载员工数据
- `parseEmployeeExcelFile()` - 解析Excel文件

## 数据库结构

使用现有的 `disciplinary_record` 表：
```sql
CREATE TABLE public.disciplinary_record (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_name text NOT NULL,
  reason text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  type text NULL,
  employee_id uuid NULL,
  -- 其他字段...
);
```

**注意**：违规记录表只存储黄牌记录，红牌通过计算得出。

## 管理规则

1. **黄牌累积**：每次违规获得1张黄牌
2. **红牌升级**：2张黄牌自动升级为1张红牌
3. **黄牌恢复**：只有在没有红牌时，无违规周才能恢复1张黄牌（最多恢复到0张）
4. **红牌机制**：红牌不会自动恢复，需要等待黄牌恢复后重新累积
5. **状态分类**：
   - 正常：无黄牌和红牌
   - 黄牌：有1张黄牌
   - 红牌：有红牌（无论黄牌数量）

## 界面优化

### 移除的功能
- ❌ 违规数量列（简化界面）
- ❌ 违规数量统计（由违规状态替代）

### 新增的功能
- ✅ 违规状态列（更直观的状态显示）
- ✅ 双击查看违规记录
- ✅ 详细的状态说明和预测
- ✅ 同步的数据操作功能

## 数据操作同步

### Excel下载同步
- ✅ 列名与主表格完全一致
- ✅ 包含违规状态信息
- ✅ 状态字段格式统一

### Excel上传同步
- ✅ 支持新旧列名格式
- ✅ 批量上传预览与主表格一致
- ✅ 数据验证规则统一

### 批量操作同步
- ✅ 预览表格列结构一致
- ✅ 状态显示格式统一
- ✅ 操作流程优化

## 下一步计划

1. **自动提醒功能**：接近红牌时发送提醒
2. **统计报表**：违规状态统计和分析
3. **规则配置**：支持自定义黄牌和红牌规则
4. **批量操作**：支持批量更新违规状态

## 测试建议

1. 添加一些测试违规记录
2. 验证状态计算是否正确
3. 测试状态变化历史显示
4. 验证界面交互是否正常
5. 测试单击和双击功能
6. 测试Excel下载和上传功能
7. 验证批量上传预览是否正确

功能已经准备就绪，界面更加简洁，数据操作完全同步，用户体验更好！ 